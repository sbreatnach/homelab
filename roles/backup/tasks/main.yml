# Install Restic + cronjobs for music and photo backups
- name: create backup user
  user:
    # using a unique user, since the backup user is owned by Debian and may change
    name: custom-backup
    comment: "Custom backup user"
    home: /home/custom-backup
    groups:
      - postgres

- name: install backup packages
  apt:
    name: "{{ item.name }}"
  with_items: "{{ backup.apt_packages }}"

- name: download Restic
  get_url:
    url: https://github.com/restic/restic/releases/download/v{{ restic.version }}/restic_{{ restic.version }}_linux_amd64.bz2
    dest: /tmp/restic.bz2

- name: unpack Restic to path
  shell: bzip2 -d -k /tmp/restic.bz2 && 
         chmod 755 /tmp/restic &&
         mv /tmp/restic /usr/bin/restic
         creates=/usr/bin/restic

- name: install credential files
  template:
    src: "{{ item.src }}.j2"
    dest: "{{ item.dest }}"
    owner: custom-backup
    mode: "{{ item.mode }}"
  with_items:
    - src: env
      dest: /home/custom-backup/.env
      mode: "700"

- name: install cron jobs
  cron:
    user: "{{ item.user|default('custom-backup') }}"
    job: "{{ item.job }}"
    name: "{{ item.name }}"
    minute: "{{ item.minute }}"
    hour: "{{ item.hour }}"
    weekday: "{{ item.weekday }}"
  with_items: "{{ cronjobs }}"